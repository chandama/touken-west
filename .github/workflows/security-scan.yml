name: Security Scan

on:
  # Run on push to main
  push:
    branches: [ main ]

  # Run on pull requests
  pull_request:
    branches: [ main ]

  # Run weekly on Monday at 9 AM UTC
  schedule:
    - cron: '0 9 * * 1'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # Install dependencies for both frontend and backend
      - name: Install frontend dependencies
        run: npm ci

      - name: Install backend dependencies
        run: cd admin-server && npm ci

      # NPM Audit Check (Frontend)
      - name: Run npm audit (Frontend)
        run: |
          echo "## Frontend Security Audit" >> $GITHUB_STEP_SUMMARY
          npm audit --production --audit-level=moderate || echo "Vulnerabilities found but continuing..."
        continue-on-error: true

      # NPM Audit Check (Backend)
      - name: Run npm audit (Backend)
        run: |
          echo "## Backend Security Audit" >> $GITHUB_STEP_SUMMARY
          cd admin-server && npm audit --production --audit-level=moderate || echo "Vulnerabilities found but continuing..."
        continue-on-error: true

      # Secret Scanning with GitLeaks (Free, no token needed)
      - name: GitLeaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # CodeQL Analysis (Free GitHub feature)
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      # Check for dangerous patterns
      - name: Check for dangerous code patterns
        run: |
          echo "## Code Pattern Analysis" >> $GITHUB_STEP_SUMMARY

          # Check for dangerouslySetInnerHTML
          if grep -r "dangerouslySetInnerHTML" src/ admin-server/ 2>/dev/null; then
            echo "::warning::dangerouslySetInnerHTML found - ensure proper sanitization"
            echo "- âš ï¸ dangerouslySetInnerHTML detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… No dangerouslySetInnerHTML" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for eval() usage
          if grep -rE "eval\s*\(" src/ admin-server/ 2>/dev/null; then
            echo "::error::eval() usage found - CRITICAL SECURITY RISK"
            echo "- âŒ eval() detected (CRITICAL)" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "- âœ… No eval() usage" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for hardcoded secrets patterns
          if grep -rE "(password|secret|api_key|apikey)\s*=\s*['\"][^'\"]{8,}" src/ admin-server/ 2>/dev/null | grep -v node_modules | grep -v ".test." | grep -v ".spec."; then
            echo "::warning::Potential hardcoded secrets found"
            echo "- âš ï¸ Potential hardcoded secrets" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… No obvious hardcoded secrets" >> $GITHUB_STEP_SUMMARY
          fi

      # Check MongoDB connection security
      - name: Check MongoDB security
        run: |
          echo "## Database Security" >> $GITHUB_STEP_SUMMARY

          # Check for proper connection string usage
          if grep -r "mongodb://" admin-server/ --exclude-dir=node_modules 2>/dev/null; then
            echo "::warning::Plain MongoDB connection found - ensure using environment variables"
            echo "- âš ï¸ Check MongoDB connection strings" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… No plain MongoDB connections" >> $GITHUB_STEP_SUMMARY
          fi

      # Generate Security Report
      - name: Generate Security Summary
        if: always()
        run: |
          echo "# ðŸ”’ Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scans Performed:**" >> $GITHUB_STEP_SUMMARY
          echo "- npm audit (frontend & backend)" >> $GITHUB_STEP_SUMMARY
          echo "- GitLeaks secret scanning" >> $GITHUB_STEP_SUMMARY
          echo "- CodeQL static analysis" >> $GITHUB_STEP_SUMMARY
          echo "- Code pattern checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the detailed results above for any issues." >> $GITHUB_STEP_SUMMARY

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0
